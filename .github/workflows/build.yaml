name: "Build"

on:
  workflow_dispatch:
  # pull_request:
  # push:
  #   branches:
  #     - main

jobs:
  build:
    runs-on: ubicloud-standard-16
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
    # Unnecessary - GH official Ubuntu image already has these up-to-date
    # - name: Install pre-reqs
    #   run : |
    #     sudo apt update && sudo apt install curl python3 python3-pip git

    - name: Checkout Repo
      uses: actions/checkout@v4

    # TODO: This exists to do all the dependency bootstrapping. It's not ideal, but they don't seem to care?
    # https://bugzilla.mozilla.org/show_bug.cgi?id=1740139
    # https://bugzilla.mozilla.org/show_bug.cgi?id=1759544
    - name: Download Firefox source
      run: |
        curl -LO https://raw.githubusercontent.com/mozilla-firefox/firefox/refs/heads/main/python/mozboot/bin/bootstrap.py
        python3 bootstrap.py --no-interactive --application-choice 'Firefox for Desktop'
        cd firefox
        VERSION=$(curl https://whattrainisitnow.com/api/firefox/releases/ | jq -r 'to_entries | sort_by(.value) | last | .key')
        git fetch origin --tags
        git checkout FIREFOX_${VERSION//./_}_RELEASE
    
        # sudo apt-get install -y \
        #   libasound2-dev \
        #   libpulse-dev \
        #   libpango1.0-dev \
        #   libx11-xcb-dev \
        #   libxrandr-dev \
        #   libxcomposite-dev \
        #   libxdamage-dev \
        #   libxcursor-dev \
        #   libxfixes-dev \
        #   libxi-dev \
        #   nasm \
        #   emscripten
    # - name: Download Firefox latest stable source and bootstrap
    #   run: |
    #     VERSION=$(curl https://whattrainisitnow.com/api/firefox/releases/ | jq -r 'to_entries | sort_by(.value) | last | .key')
    #     TARBALL_URL="https://archive.mozilla.org/pub/firefox/releases/${VERSION}/source/firefox-${VERSION}.source.tar.xz"
    #     curl -L -o firefox-source.tar.xz ${TARBALL_URL}
    #     tar -xf firefox-source.tar.xz --strip-components=1
    #     curl -L -o wasi.deb https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-27/wasi-sdk-27.0-x86_64-linux.deb
    #     sudo apt install ./wasi.deb
    #     ./mach bootstrap --application-choice "Firefox for Desktop"
      

    - name: Add mozconfig from repo
      run: |
        cp ${GITHUB_WORKSPACE}/MozConfigs/Linux64/mozconfig ${GITHUB_WORKSPACE}/firefox/mozconfig

    - name: Build firefox
      run: |
        cd firefox
        ./mach build

    - name: Tarball
      run: |
        tar -cf firefox.tar firefox

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tarball
        path: firefox.tar
        retention-days: 5
